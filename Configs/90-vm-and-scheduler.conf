# =============================================================================
# System tuning via systemd-tmpfiles
# Format:  w <path> <mode> <uid> <gid> <age> <argument>
# Fields we don't use are left as '-' to keep defaults.
# =============================================================================

# -----------------------------------------------------------------------------
# Memory reclaim & VM watermarks
# -----------------------------------------------------------------------------
# Keep THP only when explicitly requested by apps (madvise) to avoid latency spikes.
w /sys/kernel/mm/transparent_hugepage/enabled        - - - - madvise
w /sys/kernel/mm/transparent_hugepage/shmem_enabled  - - - - advise
w /sys/kernel/mm/transparent_hugepage/defrag         - - - - never

# Reclaim behavior and baseline free memory reserves.
w /proc/sys/vm/zone_reclaim_mode       - - - - 0          # don't reclaim from local node aggressively
w /proc/sys/vm/min_free_kbytes         - - - - 1048576    # ~1GiB reserved; prevents deep stalls on heavy I/O
w /proc/sys/vm/watermark_boost_factor  - - - - 1          # minimal boost
w /proc/sys/vm/watermark_scale_factor  - - - - 500        # conservative scaling
w /proc/sys/vm/compaction_proactiveness - - - - 0         # disable proactive compaction (reduce kcompactd CPU)

# Swapping policy.
w /proc/sys/vm/swappiness              - - - - 10         # prefer page cache over swapping

# Multi-gen LRU: enable to improve cache decisions (5 = enable all tiers).
w /sys/kernel/mm/lru_gen/enabled       - - - - 5

# Page lock behavior (fairness can hurt I/O throughput a bit; '1' trades fairness for throughput).
w /proc/sys/vm/page_lock_unfairness    - - - - 1

# -----------------------------------------------------------------------------
# Write-back tuning (smooth large sequential writes to external SSDs)
# -----------------------------------------------------------------------------
# Start background flushing at 256 MiB; keep the flusher active.
w /proc/sys/vm/dirty_background_bytes  - - - - 268435456

# Hard throttle at 2 GiB to avoid long burstâ†’stall cycles.
w /proc/sys/vm/dirty_bytes             - - - - 2147483648

# Flush more frequently; don't let dirty pages linger.
w /proc/sys/vm/dirty_writeback_centisecs - - - - 200      # 2s
w /proc/sys/vm/dirty_expire_centisecs    - - - - 1000     # 10s

# Ensure ratio-based knobs are off when using *_bytes.
w /proc/sys/vm/dirty_background_ratio   - - - - 0
w /proc/sys/vm/dirty_ratio              - - - - 0

# -----------------------------------------------------------------------------
# Scheduler knobs (general desktop/server responsiveness)
# -----------------------------------------------------------------------------
w /proc/sys/kernel/sched_child_runs_first         - - - - 0
w /proc/sys/kernel/sched_autogroup_enabled        - - - - 1
w /proc/sys/kernel/sched_cfs_bandwidth_slice_us    - - - - 3000

# Low-level scheduler timing/debug controls (leave as is unless you know you need different values)
w /sys/kernel/debug/sched/base_slice_ns           - - - - 3000000
w /sys/kernel/debug/sched/migration_cost_ns       - - - - 500000
w /sys/kernel/debug/sched/nr_migrate              - - - - 8

# -----------------------------------------------------------------------------
# Limits & misc
# -----------------------------------------------------------------------------
# Allow very high map count (useful for large apps/containers/VMs).
w /proc/sys/vm/max_map_count            - - - - 2147483642